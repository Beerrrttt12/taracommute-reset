<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TaraCommute – Reset Password</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f6f7f9;color:#111}
    .card{max-width:520px;margin:48px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    h1{margin:0 0 8px 0;font-size:22px}
    p{margin:8px 0;color:#555}
    .row{margin-top:16px}
    input{display:block;width:100%;padding:12px 14px;border:1px solid #d0d5dd;border-radius:8px;font-size:16px;background:#fff}
    input.error{border-color:#ef4444}
    button{margin-top:12px;width:100%;padding:12px 14px;border:0;border-radius:8px;background:#16a34a;color:#fff;font-weight:600;font-size:16px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .msg{margin-top:12px;padding:12px 14px;border-radius:8px;font-size:14px}
    .err{background:#fee2e2;color:#991b1b}
    .ok{background:#dcfce7;color:#14532d}
    .muted{color:#6b7280;font-size:12px;margin-top:8px}
    .hide{display:none}
    .req{margin-top:12px;padding:10px 12px;border:1px dashed #e5e7eb;border-radius:8px;background:#fafafa}
    .req h2{margin:0 0 8px 0;font-size:14px;color:#374151}
    .req .item{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:14px}
    .req .item.bad{color:#991b1b}
    .req .item.good{color:#14532d}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.bad{background:#ef4444}
    .dot.good{background:#16a34a}
  </style>
</head>
<body>
  <div class="card">
    <h1>Reset your password</h1>
    <p>Enter a new password for your TaraCommute account.</p>

    <div id="error" class="msg err hide"></div>
    <div id="ok" class="msg ok hide"></div>

    <div class="row"><input id="password" type="password" placeholder="New password" autocomplete="new-password" /></div>
    <div class="row"><input id="confirm" type="password" placeholder="Confirm new password" autocomplete="new-password" /></div>

    <div id="requirements" class="req">
      <h2>Password must contain:</h2>
      <div id="r-len" class="item bad"><span class="dot bad"></span>At least 8 characters</div>
      <div id="r-low" class="item bad"><span class="dot bad"></span>Lowercase letter</div>
      <div id="r-up"  class="item bad"><span class="dot bad"></span>Uppercase letter</div>
      <div id="r-num" class="item bad"><span class="dot bad"></span>Digit</div>
      <div id="r-sym" class="item bad"><span class="dot bad"></span>Symbol (!@#$…)</div>
      <div id="r-match" class="item bad"><span class="dot bad"></span>Passwords match</div>
    </div>

    <button id="submit" disabled>Update Password</button>
    <div class="muted" id="status"></div>
  </div>

  <script>
    // CONFIG
    const SUPABASE_URL = 'https://xynxgzkmvehlhtnqubsm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5bnhnemttdmVobGh0bnF1YnNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDU1NzUsImV4cCI6MjA3MzIyMTU3NX0.1P8xgvLzsHL3nscksnSf8t6azMI8uHAUA4cd_eUQNsY';

    // Read magic link params (hash or query fallback)
    const qs = new URL(window.location.href);
    const hash = qs.hash && qs.hash.startsWith('#') ? qs.hash.slice(1) : '';
    const params = new URLSearchParams(hash);
    let accessToken = params.get('access_token');
    let type = params.get('type');

    // Fallback if we were hit as /auth/v1/verify?token=...&type=...
    if (!accessToken) {
      const verifyToken = qs.searchParams.get('token');
      if (verifyToken) {
        fetch(`${SUPABASE_URL}/auth/v1/verify?type=recovery&token=${encodeURIComponent(verifyToken)}`, {
          method: 'POST',
          headers: { 'apikey': SUPABASE_ANON_KEY }
        }).then(async (res) => {
          const body = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(body.error_description || body.error || 'Failed to verify recovery token');
          accessToken = body?.access_token || body?.accessToken || body?.data?.access_token;
          if (!accessToken) throw new Error('Missing access_token from verification');
          const newHash = `#type=recovery&access_token=${encodeURIComponent(accessToken)}`;
          if (location.hash !== newHash) location.hash = newHash;
          // re-run validation state after token fetch
          updateUI();
        }).catch((e) => {
          show(document.getElementById('error'), e.message || 'Verification failed');
          document.getElementById('submit').disabled = true;
        });
      }
    }

    const errorEl = document.getElementById('error');
    const okEl = document.getElementById('ok');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('submit');
    const pw = document.getElementById('password');
    const cf = document.getElementById('confirm');

    function show(el, text){ el.textContent = text; el.classList.remove('hide'); }
    function hideEl(el){ el.classList.add('hide'); el.textContent = ''; }
    function setBusy(b){ btn.disabled = b; statusEl.textContent = b ? 'Updating…' : ''; }

    function mark(el, ok){
      el.classList.toggle('good', !!ok); el.classList.toggle('bad', !ok);
      const dot = el.querySelector('.dot');
      dot.classList.toggle('good', !!ok); dot.classList.toggle('bad', !ok);
    }

    function validate(p){
      return {
        len: p.length >= 8,
        low: /[a-z]/.test(p),
        up: /[A-Z]/.test(p),
        num: /\d/.test(p),
        sym: /[^\da-zA-Z]/.test(p)
      };
    }

    function updateUI(){
      const v = validate(pw.value);
      const match = pw.value.length > 0 && pw.value === cf.value;
      mark(document.getElementById('r-len'), v.len);
      mark(document.getElementById('r-low'), v.low);
      mark(document.getElementById('r-up'),  v.up);
      mark(document.getElementById('r-num'), v.num);
      mark(document.getElementById('r-sym'), v.sym);
      mark(document.getElementById('r-match'), match);

      pw.classList.toggle('error', !(v.len && v.low && v.up && v.num && v.sym));
      cf.classList.toggle('error', !match && cf.value.length > 0);

      const allOk = v.len && v.low && v.up && v.num && v.sym && match && !!accessToken && (type ?? 'recovery') === 'recovery';
      btn.disabled = !allOk;
    }

    pw.addEventListener('input', updateUI);
    cf.addEventListener('input', updateUI);
    updateUI();

    async function updatePassword(){
      hideEl(errorEl); hideEl(okEl); setBusy(true);
      try {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({ password: pw.value.trim() })
        });
        const text = await res.text();
        if (!res.ok){
          let msg = 'Failed to update password.';
          try { const j = JSON.parse(text); msg = j.message || j.error_description || msg; } catch {}
          throw new Error(`${res.status} ${msg}`);
        }
        show(okEl, 'Password updated successfully. You can now sign in with your new password.');
      } catch(e){
        show(errorEl, e.message || 'Unexpected error.');
      } finally { setBusy(false); }
    }

    document.getElementById('submit').addEventListener('click', updatePassword);
  </script>
</body>
</html>
